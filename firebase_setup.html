<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        document.addEventListener('DOMContentLoaded', async () => {
            const statusElem = document.getElementById('status');
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // Sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Get user's location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const apiKey = 'b9b6b7a5a812371549b0f594b595a098'; // TODO: Replace with your API key
                        const weatherApiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`;

                        try {
                            const response = await fetch(weatherApiUrl);
                            const weather = await response.json();

                            const weatherData = {
                                location: `${weather.name}, ${weather.sys.country}`,
                                temp: `${weather.main.temp}Â°C`,
                                condition: weather.weather[0].description,
                                wind: `${weather.wind.speed} m/s`,
                                humidity: `${weather.main.humidity}%`,
                                sunlight: "N/A", // OpenWeatherMap free tier doesn't provide this directly
                                irradiance: "N/A", // OpenWeatherMap free tier doesn't provide this directly
                                sunrise: new Date(weather.sys.sunrise * 1000).toLocaleTimeString(),
                                sunset: new Date(weather.sys.sunset * 1000).toLocaleTimeString()
                            };

                            const weatherDocRef = doc(db, 'artifacts', appId, 'public', 'weather', 'current');
                            await setDoc(weatherDocRef, weatherData);

                            statusElem.textContent = 'Success! Weather data has been uploaded to Firebase. You can now close this tab.';
                            statusElem.classList.remove('text-gray-500');
                            statusElem.classList.add('text-green-600', 'font-semibold');

                        } catch (e) {
                             console.error('Failed to fetch weather data:', e);
                             statusElem.textContent = 'Error: Failed to fetch weather data. Please check the console for details.';
                             statusElem.classList.remove('text-gray-500');
                             statusElem.classList.add('text-red-600', 'font-semibold');
                        }
                    }, (error) => {
                        console.error('Geolocation error:', error);
                        statusElem.textContent = 'Error: Geolocation is not enabled or permission was denied.';
                        statusElem.classList.remove('text-gray-500');
                        statusElem.classList.add('text-red-600', 'font-semibold');
                    });
                } else {
                    statusElem.textContent = 'Error: Geolocation is not supported by this browser.';
                    statusElem.classList.remove('text-gray-500');
                    statusElem.classList.add('text-red-600', 'font-semibold');
                }

            } catch (e) {
                console.error('Firebase setup failed:', e);
                statusElem.textContent = 'Error: Failed to set up Firebase. Please check the console for details.';
                statusElem.classList.remove('text-gray-500');
                statusElem.classList.add('text-red-600', 'font-semibold');
            }
        });
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
    <div class="p-8 max-w-sm mx-auto bg-white rounded-xl shadow-lg space-y-2 text-center">
        <h1 class="text-xl font-bold text-gray-900">Firebase Setup</h1>
        <p id="status" class="text-gray-500">Initializing Firebase and uploading data...</p>
    </div>
</body>
</html>
