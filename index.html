<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volt Vision - Real-Time Microgrid Monitoring</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1b5e20;
            --secondary: #2e7d32;
            --accent: #4caf50;
            --success: #689f38;
            --warning: #f57c00;
            --danger: #d32f2f;
            --light: #f1f8e9;
            --dark: #004d40;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--dark), var(--primary), var(--secondary));
            background-attachment: fixed;
            min-height: 100vh;
            padding: 1rem;
            color: #333;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        }

        .dashboard-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(1, 1fr);
        }

        @media (min-width: 640px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .col-span-2-lg {
                grid-column: span 2;
            }
            .col-span-4-lg {
                grid-column: span 4;
            }
        }

        .data-value {
            font-weight: 800;
            color: var(--primary);
            font-size: 2rem;
            margin: 0.5rem 0;
            letter-spacing: -1px;
        }

        .data-label {
            font-size: 0.875rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .real-time-badge {
            background: var(--accent);
            color: white;
            font-size: 0.6rem;
            padding: 4px 10px;
            border-radius: 16px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        .notification-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .energy-score {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--success), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .progress-bar-container {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            border-radius: 4px;
        }

        .alert-card {
            border-left: 5px solid;
            transition: all 0.3s ease;
            animation: alert-pulse 1.5s infinite;
        }

        .alert-card.danger {
            border-color: var(--danger);
            background-color: rgba(211, 47, 47, 0.08);
            animation: alert-pulse-danger 1.5s infinite;
        }

        .alert-card.warning {
            border-color: var(--warning);
            background-color: rgba(245, 124, 0, 0.08);
        }

        @keyframes alert-pulse-danger {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }

        .nav-tabs {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(46, 125, 50, 0.2);
            border-radius: 12px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab.active {
            background: var(--secondary);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chat bot specific styles */
        .chat-bot-icon {
            background: linear-gradient(45deg, #3b82f6, #60a5fa);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .chat-bot-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }
        .chat-container {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 320px;
            height: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 100;
        }
        .chat-header {
            background: var(--secondary);
            color: white;
            padding: 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .user-message {
            background-color: #e5e7eb;
            padding: 8px 12px;
            border-radius: 12px 12px 0 12px;
            align-self: flex-end;
        }
        .bot-message {
            background-color: var(--primary);
            color: white;
            padding: 8px 12px;
            border-radius: 12px 12px 12px 0;
            align-self: flex-start;
        }
        .chat-message-text {
            font-size: 0.875rem;
        }


        /* Responsive chart container */
        .chart-container {
            position: relative;
            height: 120px;
            width: 100%;
        }

        /* Trading Alert Modal */
        .trade-alert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        /* Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Energy Flow Diagram Animations */
        @keyframes flow-animation {
            to { stroke-dashoffset: -100; }
        }

        .energy-flow-path {
            stroke-width: 4;
            stroke-dasharray: 50;
            stroke-dashoffset: 0;
            fill: none;
            stroke-linecap: round;
            animation: flow-animation 2s linear infinite;
        }
        
        .flow-line-green { stroke: #10b981; }
        .flow-line-yellow { stroke: #f59e0b; }
        .flow-line-blue { stroke: #3b82f6; }
        .flow-line-red { stroke: #d32f2f; }

        /* Emergency alert specific styles */
        .emergency-alert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            max-width: 400px;
            text-align: center;
            border-left: 5px solid var(--danger);
            animation: fadeIn 0.5s ease;
        }
        .emergency-alert-button {
            position: fixed;
            bottom: 24px;
            left: 24px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            background: var(--danger);
            color: white;
            z-index: 100;
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="flex flex-col items-center justify-center min-h-screen p-4" style="background: linear-gradient(135deg, var(--dark), var(--primary), var(--secondary));">
        <div class="glass-card p-8 w-full max-w-sm text-center">
            <img src="https://raw.githubusercontent.com/vfxkaotaku/volt-vision/main/png.png" alt="Volt Vision Logo" class="w-20 h-20 mb-4 rounded-lg shadow-md mx-auto">
            <h1 class="font-bold text-3xl text-green-800 mb-2">Volt Vision</h1>
            <p class="text-sm text-green-600 mb-8">Login to your Microgrid Dashboard</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="contact" class="block text-left text-sm font-medium text-gray-700 mb-2">Email or Phone Number</label>
                    <input type="text" id="contact" name="contact" placeholder="Enter your email or phone" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="mb-6">
                    <label for="plant-type" class="block text-left text-sm font-medium text-gray-700 mb-2">My Power Plant Type</label>
                    <select id="plant-type" name="plant-type" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        <option value="" disabled selected>Select a plant type</option>
                        <option value="Solar">Solar Panels</option>
                        <option value="Wind">Wind Turbine</option>
                        <option value="Hybrid">Hybrid (Solar & Wind)</option>
                    </select>
                </div>
                <button type="submit" class="w-full py-3 rounded-full bg-green-600 text-white font-bold text-lg hover:bg-green-700 transition">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard - Initially hidden -->
    <div id="main-dashboard" class="container hidden">
        <!-- Header -->
        <header class="glass-card p-5 md:p-6 shadow-lg mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <img src="https://raw.githubusercontent.com/vfxkaotaku/volt-vision/main/png.png" alt="Volt Vision Logo" class="w-16 h-16 rounded-lg shadow-md">
                    <div>
                        <h1 class="font-bold text-2xl md:text-3xl text-green-800">VOLT VISION</h1>
                        <p class="text-xs md:text-sm text-green-600">Advanced Microgrid Monitoring</p>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-4 text-center md:text-right text-gray-700">
                    <div id="connection-status" class="flex items-center gap-2 px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-semibold">
                        <i class="fas fa-wifi"></i>
                        <span>Live Data Stream</span>
                    </div>
                    <div id="location-info">
                        <p class="text-sm font-medium flex items-center gap-2 justify-center md:justify-end">
                            <i class="fas fa-map-marker-alt text-green-600"></i>
                            <span id="location-name">Nashik, Maharashtra</span>
                        </p>
                        <p class="text-xs font-mono text-gray-500 flex items-center gap-2 justify-center md:justify-end mt-1">
                            <i class="fas fa-clock text-green-600"></i>
                            <span id="last-updated">Updating...</span>
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="glass-card p-3 mb-6">
            <div class="nav-tabs">
                <div class="nav-tab active" data-panel="dashboard">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-tab" data-panel="energy">
                    <i class="fas fa-plug"></i>
                    <span>Energy Flow</span>
                </div>
                <div class="nav-tab" data-panel="weather">
                    <i class="fas fa-cloud-sun"></i>
                    <span>Weather</span>
                </div>
                <div class="nav-tab" data-panel="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </div>
                <div class="nav-tab" data-panel="trading">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Grid Trading</span>
                </div>
                <div class="nav-tab" data-panel="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </div>
        </div>

        <!-- Dashboard Panel -->
        <div id="dashboard-panel" class="panel active">
            <div class="dashboard-grid">
                <!-- Live Status & Energy Source Card (Spans 2 columns) -->
                <div class="glass-card p-6 col-span-full lg:col-span-2 flex flex-col md:flex-row items-center justify-between gap-6">
                    <!-- Status -->
                    <div>
                        <h2 class="text-lg md:text-xl font-semibold text-green-800 flex items-center gap-2 mb-2">
                            <i class="fas fa-bolt"></i> Microgrid Live Status
                            <span class="real-time-badge">ACTIVE</span>
                        </h2>
                        <div id="mode-status" class="flex items-center gap-2 text-sm font-medium px-4 py-2 rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-globe-americas"></i>
                            <span>Grid-Tied Mode</span>
                        </div>
                    </div>
                    <!-- Energy Source -->
                    <div class="flex flex-col md:flex-row items-center gap-4 text-center md:text-left">
                        <div id="source-icon" class="text-4xl text-green-600">
                            <i class="fas fa-solar-panel"></i>
                        </div>
                        <div class="max-w-[200px] md:max-w-none">
                            <div class="text-xl md:text-2xl font-bold" id="source-main-label">
                                Powering from Solar
                            </div>
                            <div class="text-sm text-gray-600" id="source-sub-label">
                                Your home is using clean, free energy from the sun.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Prediction Card (Spans 2 columns) -->
                <div class="glass-card relative col-span-full lg:col-span-2 p-6">
                    <span class="notification-badge">AI</span>
                    <h2 class="text-lg md:text-xl font-semibold text-green-800 flex items-center gap-2 mb-4">
                        <i class="fas fa-brain"></i> AI Energy Prediction
                    </h2>
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="text-center md:text-left">
                            <div class="energy-score">
                                <span id="energy-efficiency-score">92</span><span class="text-xl">%</span>
                            </div>
                            <div class="data-label">System Efficiency Score</div>
                        </div>
                        <div class="w-full md:w-2/3 chart-container">
                            <div class="flex justify-between text-xs text-gray-600 mb-1">
                                <span>Generation Forecast (Next 12h)</span>
                                <span class="font-semibold" id="predicted-generation">42.5 kWh</span>
                            </div>
                            <canvas id="generation-prediction-chart"></canvas>
                        </div>
                    </div>
                    <div class="mt-4 p-4 rounded-xl bg-blue-50 border-l-4 border-blue-500">
                        <div class="flex items-center gap-2 text-blue-800 font-medium text-sm mb-1">
                            <i class="fas fa-robot"></i> AI Recommendation:
                        </div>
                        <p class="text-sm text-blue-700" id="ai-recommendation">Based on forecast, charge batteries fully before sunset to maximize savings.</p>
                    </div>
                </div>

                <!-- Full-Width Weather Report Card -->
                <div class="glass-card col-span-full p-6">
                    <h2 class="text-lg md:text-xl font-semibold text-green-800 flex items-center gap-2 mb-4">
                        <i class="fas fa-cloud-sun"></i> Live Weather Report
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center md:text-left">
                           <div class="flex flex-col md:flex-row items-center gap-4">
                            <div class="text-center">
                                <i id="weather-icon" class="text-5xl md:text-6xl text-yellow-500 fas fa-sun"></i>
                                <div class="text-xs font-medium text-gray-600 mt-2" id="weather-condition">Clear Sky</div>
                            </div>
                            <div class="text-center">
                                <div class="data-value text-green-700">
                                    <span id="weather-temp">29.1</span><span class="text-xl">°C</span>
                                </div>
                                <div class="text-xs font-medium text-gray-600">Current Temperature</div>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Wind</div>
                            <div class="data-value text-blue-600 text-lg">
                                <span id="weather-wind">8.5</span> <span class="text-sm">km/h</span>
                            </div>
                            <div class="text-xs text-gray-500">Direction: N</div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Humidity</div>
                            <div class="data-value text-blue-600 text-lg">
                                <span id="weather-humidity">65</span> <span class="text-sm">%</span>
                            </div>
                            <div class="text-xs text-gray-500">Dew Point: 20°C</div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <div class="text-sm text-gray-500 font-semibold uppercase">Pressure</div>
                            <div class="data-value text-blue-600 text-lg">
                                <span id="weather-pressure">1012</span> <span class="text-sm">hPa</span>
                            </div>
                            <div class="text-xs text-gray-500">Status: Normal</div>
                        </div>
                    </div>
                </div>
                
                <!-- Solar Generation Card -->
                <div id="solar-card" class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-green-800 flex items-center gap-2">
                            <i class="fas fa-solar-panel text-yellow-500"></i> Solar
                        </h2>
                        <div class="text-sm text-gray-600 flex items-center gap-1">
                            <i class="fas fa-chart-bar"></i>
                            <span class="font-medium" id="solar-today-gen">18.6 kWh Today</span>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <div class="data-value text-yellow-600">
                            <span id="solar-current-output">3.2</span> <span class="text-xl">kW</span>
                        </div>
                        <div class="data-label">Current Output</div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="solar-progress" class="progress-bar bg-yellow-500" style="width: 64%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span>0 kW</span>
                        <span>5 kW Max</span>
                    </div>
                </div>

                <!-- Wind Generation Card -->
                <div id="wind-card" class="glass-card p-6 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-green-800 flex items-center gap-2">
                            <i class="fas fa-wind text-blue-500"></i> Wind
                        </h2>
                        <div class="text-sm text-gray-600 flex items-center gap-1">
                            <i class="fas fa-chart-bar"></i>
                            <span class="font-medium" id="wind-today-gen">18.6 kWh Today</span>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <div class="data-value text-blue-600">
                            <span id="wind-current-output">3.2</span> <span class="text-xl">kW</span>
                        </div>
                        <div class="data-label">Current Output</div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="wind-progress" class="progress-bar bg-blue-500" style="width: 64%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span>0 kW</span>
                        <span>5 kW Max</span>
                    </div>
                </div>

                <!-- Battery Status Card -->
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-green-800 flex items-center gap-2">
                            <i class="fas fa-car-battery text-green-600"></i> Battery
                        </h2>
                        <div class="text-sm text-gray-600 flex items-center gap-1">
                            <i class="fas fa-clock"></i>
                            <span class="font-medium" id="backup-time">8.2 hrs Backup</span>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <div class="data-value text-green-700">
                            <span id="battery-level-value">72</span><span class="text-xl">%</span>
                        </div>
                        <div class="data-label">Current Capacity</div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="battery-progress" class="progress-bar bg-green-600" style="width: 72%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span>0%</span>
                        <span>100%</span>
                    </div>
                    <div id="battery-health-alert" class="alert-card warning mt-4 p-3 rounded-lg flex items-center gap-3 hidden">
                        <i class="fas fa-exclamation-triangle text-orange-800"></i>
                        <p class="text-xs text-orange-700 font-medium">Battery efficiency drop detected.</p>
                    </div>
                </div>

                <!-- Energy Consumption Card -->
                <div class="glass-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-green-800 flex items-center gap-2">
                            <i class="fas fa-plug text-blue-500"></i> Consumption
                        </h2>
                        <div class="text-sm text-gray-600 flex items-center gap-1">
                            <i class="fas fa-chart-line"></i>
                            <span class="font-medium" id="today-usage">15.4 kWh Today</span>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <div class="data-value text-blue-600">
                            <span id="current-load">2.8</span> <span class="text-xl">kW</span>
                        </div>
                        <div class="data-label">Current Load</div>
                    </div>
                    <div class="progress-bar-container">
                        <div id="consumption-progress" class="progress-bar bg-blue-500" style="width: 56%;"></div>
                    </div>
                    <div id="anomaly-alert" class="alert-card danger mt-4 p-3 rounded-lg flex items-center gap-3 hidden">
                        <i class="fas fa-exclamation-circle text-red-800"></i>
                        <p class="text-xs text-red-700 font-medium">Unusual energy spike detected.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Energy Flow Panel -->
        <div id="energy-panel" class="panel">
            <div class="glass-card p-6">
                <h2 class="text-2xl font-bold text-green-800 mb-6">Energy Flow Diagram</h2>
                <div class="flex flex-col items-center justify-center h-[500px] relative">
                    <!-- Energy sources -->
                    <div class="flex w-full justify-around items-center">
                        <div id="flow-source-1" class="flex flex-col items-center">
                            <div class="text-4xl text-yellow-500"><i class="fas fa-solar-panel"></i></div>
                            <div class="mt-2 font-semibold text-sm" id="flow-source-1-label">Solar Panels</div>
                            <div id="flow-solar-output" class="text-xs text-gray-500">3.2 kW</div>
                        </div>
                        <div id="flow-source-2" class="flex flex-col items-center hidden">
                            <div class="text-4xl text-blue-500"><i class="fas fa-wind"></i></div>
                            <div class="mt-2 font-semibold text-sm" id="flow-source-2-label">Wind Turbine</div>
                            <div id="flow-wind-output" class="text-xs text-gray-500">3.2 kW</div>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="text-4xl text-blue-500"><i class="fas fa-warehouse"></i></div>
                            <div class="mt-2 font-semibold text-sm">Main Grid</div>
                            <div id="flow-grid-status" class="text-xs text-green-600">Connected</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <span id="grid-current">12.5A</span> |
                                <span id="grid-voltage">240V</span>
                            </div>
                            <div id="grid-bill" class="text-sm font-bold text-red-500 mt-1">₹ 2,500</div>
                            <button id="purchase-energy-btn" class="hidden mt-2 px-4 py-2 rounded-xl bg-blue-500 text-white font-bold hover:bg-blue-600 transition text-sm">Purchase from Grid</button>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="text-4xl text-green-600"><i class="fas fa-car-battery"></i></div>
                            <div class="mt-2 font-semibold text-sm">Battery</div>
                            <div id="flow-battery-status" class="text-xs text-gray-500">72%</div>
                        </div>
                    </div>

                    <!-- Flow lines and arrows -->
                    <div class="relative w-full h-[300px] flex items-center justify-center">
                        <!-- Home Load in center -->
                        <div class="flex flex-col items-center absolute p-6 bg-white rounded-lg shadow-xl" style="z-index: 10;">
                            <div class="text-5xl text-blue-600"><i class="fas fa-home"></i></div>
                            <div class="mt-2 font-bold text-lg">Home Load</div>
                            <div id="flow-home-load" class="text-xl font-mono text-blue-800 mt-1">2.8 kW</div>
                            <div id="flow-load-source" class="text-xs text-gray-500 mt-1">Sourced from: Solar</div>
                        </div>
                        
                        <!-- New Energy Meter Card -->
                        <div class="flex flex-col items-center absolute p-4 bg-white rounded-lg shadow-md -bottom-10 right-20 w-[150px]">
                            <i class="fas fa-tachometer-alt text-3xl text-gray-600"></i>
                            <div class="font-bold text-md mt-2">Energy Meter</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <span id="meter-current">12.5A</span> | 
                                <span id="meter-voltage">240V</span>
                            </div>
                        </div>

                        <!-- Energy Flow Lines (SVG for smooth lines) -->
                        <svg class="absolute w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none" style="z-index: 1;">
                            
                            <!-- Paths now enter the home load box from the left and right sides. -->
                            <!-- Solar to Home Load (enters from left side) -->
                            <path d="M15 25 Q 35 45, 45 50" fill="transparent" stroke-linecap="round" id="solar-to-home-path" class="hidden energy-flow-path"></path>
                            <!-- Wind to Home Load (enters from left side, offset slightly) -->
                            <path d="M35 25 Q 35 45, 45 50" fill="transparent" stroke-linecap="round" id="wind-to-home-path" class="hidden energy-flow-path"></path>
                            <!-- Grid to Home Load (enters from right side) -->
                            <path d="M65 25 Q 65 45, 55 50" fill="transparent" stroke-linecap="round" id="grid-to-home-path" class="hidden energy-flow-path"></path>
                            <!-- Battery to Home Load (enters from right side, offset slightly) -->
                            <path d="M85 25 Q 65 35, 55 50" fill="transparent" stroke-linecap="round" id="battery-to-home-path" class="hidden energy-flow-path"></path>
                            <!-- Solar/Wind to Grid (Selling), flows over the top -->
                            <path d="M15 25 Q 40 10, 65 25" fill="transparent" stroke-linecap="round" id="solar-to-grid-path" class="hidden energy-flow-path"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather Panel -->
        <div id="weather-panel" class="panel">
            <div class="glass-card p-6">
                <h2 class="text-2xl font-bold text-green-800 mb-4">7-Day Weather & Solar Forecast</h2>
                <div class="dashboard-grid gap-6">
                    <div class="col-span-full">
                        <div class="w-full h-80 bg-gray-50 rounded-lg p-4">
                            <canvas id="solar-forecast-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-span-full grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        <!-- Forecast Card -->
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <div class="text-xs text-gray-500 font-medium">Today</div>
                            <i class="fas fa-sun text-4xl text-yellow-500 my-2"></i>
                            <div class="font-bold text-lg text-green-800">32°C</div>
                            <div class="text-sm text-gray-700">Clear</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <div class="text-xs text-gray-500 font-medium">Sat</div>
                            <i class="fas fa-cloud text-4xl text-gray-500 my-2"></i>
                            <div class="font-bold text-lg text-green-800">30°C</div>
                            <div class="text-sm text-gray-700">Cloudy</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <div class="text-xs text-gray-500 font-medium">Sun</div>
                            <i class="fas fa-cloud-sun-rain text-4xl text-blue-500 my-2"></i>
                            <div class="font-bold text-lg text-green-800">28°C</div>
                            <div class="text-sm text-gray-700">Rain</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <div class="text-xs text-gray-500 font-medium">Mon</div>
                            <i class="fas fa-cloud-sun text-4xl text-yellow-500 my-2"></i>
                            <div class="font-bold text-lg text-green-800">31°C</div>
                            <div class="text-sm text-gray-700">Partly Cloudy</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <div class="text-xs text-gray-500 font-medium">Tue</div>
                            <i class="fas fa-sun text-4xl text-yellow-500 my-2"></i>
                            <div class="font-bold text-lg text-green-800">33°C</div>
                            <div class="text-sm text-gray-700">Clear</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <div class="text-xs text-gray-500 font-medium">Wed</div>
                            <i class="fas fa-cloud-rain text-4xl text-blue-500 my-2"></i>
                            <div class="font-bold text-lg text-green-800">29°C</div>
                            <div class="text-sm text-gray-700">Rain</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <div class="text-xs text-gray-500 font-medium">Thu</div>
                            <i class="fas fa-sun text-4xl text-yellow-500 my-2"></i>
                            <div class="font-bold text-lg text-green-800">32°C</div>
                            <div class="text-sm text-gray-700">Clear</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Panel -->
        <div id="analytics-panel" class="panel">
            <div class="glass-card p-6">
                <h2 class="text-2xl font-bold text-green-800 mb-4">Detailed Energy Analytics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card p-4 h-80">
                        <h3 class="font-semibold text-lg mb-2">Weekly Consumption (kWh)</h3>
                        <canvas id="weekly-consumption-chart"></canvas>
                    </div>
                    <div class="glass-card p-4 h-80">
                        <h3 class="font-semibold text-lg mb-2">Energy Usage Breakdown</h3>
                        <canvas id="usage-breakdown-chart"></canvas>
                    </div>
                </div>
                <div class="glass-card p-4 mt-6">
                    <h3 class="font-semibold text-lg mb-2">Consumption vs. Generation</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-gray-500 text-sm">Today's Generation</div>
                            <div class="text-2xl font-bold text-yellow-600" id="analytics-gen">18.6 kWh</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-sm">Today's Consumption</div>
                            <div class="text-2xl font-bold text-blue-600" id="analytics-con">15.4 kWh</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-sm">Net Surplus</div>
                            <div class="text-2xl font-bold text-green-600" id="analytics-surplus">3.2 kWh</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid Trading Panel -->
        <div id="trading-panel" class="panel">
            <div class="glass-card p-6">
                <h2 class="text-2xl font-bold text-green-800 mb-6">P2P Energy Trading</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Current Market Status -->
                    <div class="lg:col-span-2 glass-card p-4">
                        <h3 class="font-semibold text-lg mb-2 flex items-center gap-2">
                            <i class="fas fa-chart-line text-green-600"></i> Market Overview
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-center">
                             <div>
                                <div class="text-gray-500 text-sm">Grid Price</div>
                                <div class="text-xl font-bold text-purple-600">₹6.50/kWh</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-sm">Local Buy Price</div>
                                <div class="text-xl font-bold text-green-600">₹5.80/kWh</div>
                            </div>
                            <div>
                                <div class="text-gray-500 text-sm">Local Sell Price</div>
                                <div class="text-xl font-bold text-orange-600">₹6.20/kWh</div>
                            </div>
                             <div>
                                <div class="text-gray-500 text-sm">Net Balance</div>
                                <div class="text-xl font-bold text-green-800">₹5,400</div>
                            </div>
                        </div>
                        <h4 class="font-medium text-lg mt-6 mb-2">Recent Trades</h4>
                        <div class="space-y-2" id="transaction-history">
                            <div class="flex justify-between items-center p-2 rounded-lg bg-gray-100 text-sm">
                                <span><i class="fas fa-arrow-down text-red-500 mr-2"></i>Sold 2.5 kWh to User 5c1d</span>
                                <span class="font-mono text-xs text-gray-600">3:15 PM</span>
                            </div>
                            <div class="flex justify-between items-center p-2 rounded-lg bg-gray-100 text-sm">
                                <span><i class="fas fa-arrow-up text-green-500 mr-2"></i>Bought 1.1 kWh from Grid</span>
                                <span class="font-mono text-xs text-gray-600">2:40 PM</span>
                            </div>
                        </div>
                    </div>

                    <!-- Trading Actions -->
                    <div class="glass-card p-4 flex flex-col items-center justify-center">
                        <h3 class="font-semibold text-lg mb-4 text-center">Trade Your Energy</h3>
                        
                        <div class="flex flex-col w-full gap-4">
                             <!-- New section: Your Energy Account -->
                             <div class="bg-gray-50 p-4 rounded-xl mb-4 text-center">
                                 <div class="text-sm text-gray-600">Your Client ID:</div>
                                 <div class="text-lg font-mono font-bold text-green-800" id="client-id">Loading...</div>
                                 <div class="text-sm text-gray-600 mt-2">Energy Balance:</div>
                                 <div class="text-2xl font-bold text-green-800 mt-1" id="energy-balance">₹ 0.00</div>
                             </div>

                            <!-- Manual Trading Form -->
                            <form id="sell-form" class="w-full">
                                <div class="mb-4">
                                    <label for="sell-quantity" class="block text-sm font-medium text-gray-700 mb-2">Quantity to Sell (kWh)</label>
                                    <input type="number" id="sell-quantity" name="sell-quantity" min="0.1" step="0.1" placeholder="e.g., 2.5" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <button type="submit" class="w-full py-3 rounded-xl bg-green-500 text-white font-bold text-lg hover:bg-green-600 transition">
                                    <i class="fas fa-arrow-up mr-2"></i> Sell to Grid
                                </button>
                            </form>
                        </div>
                        <p class="text-center text-xs text-gray-500 mt-4">Trade prices are dynamic and change based on supply and demand.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="panel">
            <div class="glass-card p-6 text-center">
                <i class="fas fa-cog text-5xl text-gray-500 mb-4"></i>
                <h2 class="text-2xl font-bold text-green-800 mb-2">System Settings</h2>
                <p class="text-gray-600">Configure your microgrid system and personal preferences here.</p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="glass-card rounded-2xl p-4 md:p-6 text-center text-gray-600 text-xs md:text-sm mt-6">
            <p class="font-medium text-green-800">© 2025 VOLT VISION | Advanced Microgrid Monitoring System</p>
            <p class="mt-2 text-xs text-gray-500">Empowering a sustainable energy future.</p>
        </footer>
    </div>

    <!-- Emergency Alert Modal (Hidden by default) -->
    <div id="emergency-alert-container" class="hidden">
        <div class="modal-overlay"></div>
        <div class="emergency-alert-modal">
            <h3 class="text-xl font-bold text-red-800 mb-2">EMERGENCY ALERT</h3>
            <p class="text-sm text-gray-700 mb-4" id="emergency-alert-message">
                System power is critically low due to low battery and poor weather conditions. Please conserve energy.
            </p>
            <button id="emergency-alert-close-btn" class="w-full py-2 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition">
                OK
            </button>
        </div>
    </div>

    <!-- Chat Bot button and container -->
    <div class="chat-bot-icon" id="chat-bot-icon">
        <i class="fas fa-comment-dots text-xl"></i>
    </div>

    <div class="chat-container hidden" id="chat-container">
        <div class="chat-header">
            Volt Vision Assistant
            <i class="fas fa-times cursor-pointer" id="close-chat"></i>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="bot-message chat-message-text">Hello! I'm here to assist you. How can I help today?</div>
        </div>
        <div class="chat-input-container">
            <input type="text" id="chat-input" placeholder="Type a command..." class="w-full px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </div>

    <!-- Trading Alert Modal (Hidden by default) -->
    <div id="trade-alert-container" class="hidden">
        <div class="modal-overlay"></div>
        <div class="trade-alert-modal">
            <h3 class="text-xl font-bold text-green-800 mb-2">Trade Request!</h3>
            <p class="text-sm text-gray-700 mb-4" id="trade-alert-message">A local client needs energy. Are you willing to sell?</p>
            <div class="flex gap-4">
                <button id="accept-trade-btn" class="flex-1 py-2 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 transition">Accept</button>
                <button id="decline-trade-btn" class="flex-1 py-2 rounded-xl bg-red-500 text-white font-bold hover:bg-red-600 transition">Decline</button>
            </div>
        </div>
    </div>

    <!-- Simple message modal for login alerts -->
    <div id="message-modal-container" class="hidden">
        <div class="modal-overlay"></div>
        <div class="trade-alert-modal">
            <h3 class="text-xl font-bold text-green-800 mb-2">Attention!</h3>
            <p class="text-sm text-gray-700 mb-4" id="message-modal-text">Please fill out all fields to log in.</p>
            <button id="message-modal-close" class="w-full py-2 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 transition">OK</button>
        </div>
    </div>
    
    <!-- Audio for alert sound -->
    <audio id="alert-sound" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/3/buzzer.wav" preload="auto"></audio>
    
    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js';

        // Firestore configuration variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userDocRef;
        let userId;
        let currentPlantType = '';
        let isEmergencyMode = false;
        let mockWeatherCondition = 'Clear Sky';
        let mockBatteryLevel = 72;
        let currentLoad = 2.8;

        // Global state for trading
        const tradeState = {
            balance: 5400,
            clientId: '0x' + Math.random().toString(16).slice(2, 8),
            sellPrice: 6.20,
            history: [
                { type: 'sold', quantity: 2.5, to: 'User 5c1d', time: '3:15 PM' },
                { type: 'bought', quantity: 1.1, from: 'Grid', time: '2:40 PM' }
            ]
        };

        const updatePlantUI = () => {
            const sourceIconEl = document.getElementById('source-icon');
            const sourceMainLabelEl = document.getElementById('source-main-label');
            const sourceSubLabelEl = document.getElementById('source-sub-label');
            const solarCard = document.getElementById('solar-card');
            const windCard = document.getElementById('wind-card');

            if (solarCard) solarCard.classList.add('hidden');
            if (windCard) windCard.classList.add('hidden');
            
            let icon, mainLabel, subLabel;

            switch (currentPlantType) {
                case 'Solar':
                    icon = 'fas fa-solar-panel';
                    mainLabel = 'Powering from Solar';
                    subLabel = 'Your home is using clean energy from the sun.';
                    if (solarCard) solarCard.classList.remove('hidden');
                    break;
                case 'Wind':
                    icon = 'fas fa-wind';
                    mainLabel = 'Powering from Wind';
                    subLabel = 'Your home is using energy generated by wind.';
                    if (windCard) windCard.classList.remove('hidden');
                    break;
                case 'Hybrid':
                    icon = 'fas fa-cloud-sun-wind';
                    mainLabel = 'Powering from Solar & Wind';
                    subLabel = 'Your home is using a combination of solar and wind energy.';
                    if (solarCard) solarCard.classList.remove('hidden'); // Show solar for hybrid
                    if (windCard) windCard.classList.remove('hidden'); // Show wind for hybrid
                    break;
                default:
                    icon = 'fas fa-question-circle';
                    mainLabel = 'Unknown Source';
                    subLabel = 'Please select your plant type.';
                    break;
            }

            if (sourceIconEl) {
                sourceIconEl.innerHTML = `<i class="${icon}"></i>`;
            }
            if (sourceMainLabelEl) {
                sourceMainLabelEl.textContent = mainLabel;
            }
            if (sourceSubLabelEl) {
                sourceSubLabelEl.textContent = subLabel;
            }
        };

        const updateLiveMetrics = () => {
            const now = new Date();
            const lastUpdatedEl = document.getElementById('last-updated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }

            if (!isEmergencyMode) {
                currentLoad = parseFloat((Math.random() * 4 + 1).toFixed(1));
            } else {
                currentLoad = parseFloat((Math.random() * 2 + 0.5).toFixed(1));
            }

            let solarOutput = 0, windOutput = 0;

            if (isEmergencyMode) {
                solarOutput = 0.1;
                windOutput = 0.1;
                mockBatteryLevel = Math.max(10, mockBatteryLevel - 5);
                mockWeatherCondition = 'Cloudy';
            } else {
                switch(currentPlantType) {
                    case 'Solar':
                        solarOutput = parseFloat((Math.random() * 5).toFixed(1));
                        break;
                    case 'Wind':
                        windOutput = parseFloat((Math.random() * 5).toFixed(1));
                        break;
                    case 'Hybrid':
                        solarOutput = parseFloat((Math.random() * 3).toFixed(1));
                        windOutput = parseFloat((Math.random() * 3).toFixed(1));
                        break;
                }
                mockBatteryLevel = Math.max(0, Math.min(100, mockBatteryLevel + (solarOutput + windOutput - currentLoad) * 2));
                const weatherConditions = ['Clear Sky', 'Partly Cloudy', 'Cloudy', 'Rain'];
                mockWeatherCondition = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];
            }

            const totalGeneration = solarOutput + windOutput;
            const batteryLevel = mockBatteryLevel;
            const efficiencyScoreEl = document.getElementById('energy-efficiency-score');
            const efficiencyScore = efficiencyScoreEl ? Math.max(75, Math.min(98, parseInt(efficiencyScoreEl.textContent) + (Math.random() * 4 - 2))) : 0;
            const carbonSaved = (totalGeneration * 0.5).toFixed(1);

            let source = 'Grid';
            let icon = 'fas fa-warehouse';
            let mainLabel = 'Powering from Grid';
            let subLabel = 'Purchasing power from the grid to meet your demand.';
            let color = 'text-blue-600';

            const purchaseEnergyBtn = document.getElementById('purchase-energy-btn');

            if (isEmergencyMode) {
                source = 'Grid';
                mainLabel = 'Emergency Grid Purchase';
                subLabel = 'Your system is purchasing power from the grid.';
                if(purchaseEnergyBtn) purchaseEnergyBtn.classList.remove('hidden');
            } else if (totalGeneration >= currentLoad) {
                source = currentPlantType;
                if(purchaseEnergyBtn) purchaseEnergyBtn.classList.add('hidden');
                switch(currentPlantType) {
                    case 'Solar':
                        icon = 'fas fa-solar-panel';
                        mainLabel = 'Powering from Solar';
                        subLabel = 'Your home is using clean, free energy from the sun.';
                        color = 'text-yellow-600';
                        break;
                    case 'Wind':
                        icon = 'fas fa-wind';
                        mainLabel = 'Powering from Wind';
                        subLabel = 'Your home is using energy generated by wind.';
                        color = 'text-blue-600';
                        break;
                    case 'Hybrid':
                        icon = 'fas fa-cloud-sun-wind';
                        mainLabel = 'Powering from Solar & Wind';
                        subLabel = 'Your home is using a combination of solar and wind energy.';
                        color = 'text-green-600';
                        break;
                }
                if (batteryLevel >= 95) {
                    source = 'Selling';
                    icon = 'fas fa-exchange-alt';
                    mainLabel = 'Selling to Grid';
                    subLabel = `Generating a surplus! Selling clean energy to the grid.`;
                    color = 'text-purple-600';
                }
            } else if (currentLoad > totalGeneration && batteryLevel > 20) {
                source = 'Battery';
                icon = 'fas fa-car-battery';
                mainLabel = 'Powering from Battery';
                subLabel = 'Using stored energy to power your home and avoid grid costs.';
                color = 'text-green-600';
                if(purchaseEnergyBtn) purchaseEnergyBtn.classList.add('hidden');
            }

            const currentLoadEl = document.getElementById('current-load');
            if (currentLoadEl) currentLoadEl.textContent = currentLoad;
            
            const consumptionProgressEl = document.getElementById('consumption-progress');
            if (consumptionProgressEl) consumptionProgressEl.style.width = `${(currentLoad / 5) * 100}%`;
            
            if (currentPlantType === 'Solar' || currentPlantType === 'Hybrid') {
                const solarOutputEl = document.getElementById('solar-current-output');
                if (solarOutputEl) solarOutputEl.textContent = solarOutput;
                const solarProgressEl = document.getElementById('solar-progress');
                if (solarProgressEl) solarProgressEl.style.width = `${(solarOutput / 5) * 100}%`;
                const solarTodayGenEl = document.getElementById('solar-today-gen');
                if (solarTodayGenEl) solarTodayGenEl.textContent = `${(parseFloat(solarTodayGenEl.textContent) + solarOutput).toFixed(1)} kWh Today`;
            }
            if (currentPlantType === 'Wind' || currentPlantType === 'Hybrid') {
                const windOutputEl = document.getElementById('wind-current-output');
                if (windOutputEl) windOutputEl.textContent = windOutput;
                const windProgressEl = document.getElementById('wind-progress');
                if (windProgressEl) windProgressEl.style.width = `${(windOutput / 5) * 100}%`;
                const windTodayGenEl = document.getElementById('wind-today-gen');
                if (windTodayGenEl) windTodayGenEl.textContent = `${(parseFloat(windTodayGenEl.textContent) + windOutput).toFixed(1)} kWh Today`;
            }
            
            const batteryLevelEl = document.getElementById('battery-level-value');
            if (batteryLevelEl) batteryLevelEl.textContent = Math.round(batteryLevel);
            const batteryProgressEl = document.getElementById('battery-progress');
            if (batteryProgressEl) batteryProgressEl.style.width = `${batteryLevel}%`;
            
            if (efficiencyScoreEl) efficiencyScoreEl.textContent = efficiencyScore.toFixed(1);
            
            const sourceIconEl = document.getElementById('source-icon');
            if (sourceIconEl) sourceIconEl.innerHTML = `<i class="${icon}"></i>`;
            if (sourceIconEl) sourceIconEl.className = `text-4xl ${color}`;
            
            const sourceMainLabelEl = document.getElementById('source-main-label');
            if (sourceMainLabelEl) sourceMainLabelEl.textContent = mainLabel;
            if (sourceMainLabelEl) sourceMainLabelEl.className = `text-xl md:text-2xl font-bold ${color}`;
            
            const sourceSubLabelEl = document.getElementById('source-sub-label');
            if (sourceSubLabelEl) sourceSubLabelEl.textContent = subLabel;

            const flowSolarOutputEl = document.getElementById('flow-solar-output');
            if (flowSolarOutputEl) flowSolarOutputEl.textContent = `${solarOutput} kW`;
            const flowWindOutputEl = document.getElementById('flow-wind-output');
            if (flowWindOutputEl) flowWindOutputEl.textContent = `${windOutput} kW`;
            const flowBatteryStatusEl = document.getElementById('flow-battery-status');
            if (flowBatteryStatusEl) flowBatteryStatusEl.textContent = `${Math.round(batteryLevel)}%`;
            const flowHomeLoadEl = document.getElementById('flow-home-load');
            if (flowHomeLoadEl) flowHomeLoadEl.textContent = `${currentLoad} kW`;
            const flowLoadSourceEl = document.getElementById('flow-load-source');
            if (flowLoadSourceEl) flowLoadSourceEl.textContent = `Sourced from: ${source}`;
            const flowSource1El = document.getElementById('flow-source-1');
            if (flowSource1El) flowSource1El.classList.toggle('hidden', currentPlantType !== 'Solar' && currentPlantType !== 'Hybrid');
            const flowSource2El = document.getElementById('flow-source-2');
            if (flowSource2El) flowSource2El.classList.toggle('hidden', currentPlantType !== 'Wind' && currentPlantType !== 'Hybrid');
            
            document.querySelectorAll('.energy-flow-path').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('flow-line-green', 'flow-line-yellow', 'flow-line-blue', 'flow-line-red');
            });
            
            const getPathElement = (pathId) => document.getElementById(pathId);
            switch (source) {
                case 'Solar':
                    const solarPath = getPathElement('solar-to-home-path');
                    if(solarPath) {
                        solarPath.classList.remove('hidden');
                        solarPath.classList.add('flow-line-yellow');
                    }
                    break;
                case 'Wind':
                    const windPath = getPathElement('wind-to-home-path');
                    if(windPath) {
                        windPath.classList.remove('hidden');
                        windPath.classList.add('flow-line-blue');
                    }
                    break;
                case 'Hybrid':
                    const hybridPath = getPathElement('solar-to-home-path');
                    if(hybridPath) {
                        hybridPath.classList.remove('hidden');
                        hybridPath.classList.add('flow-line-green');
                    }
                    break;
                case 'Battery':
                    const batteryPath = getPathElement('battery-to-home-path');
                    if(batteryPath) {
                        batteryPath.classList.remove('hidden');
                        batteryPath.classList.add('flow-line-green');
                    }
                    break;
                case 'Grid':
                    const gridPath = getPathElement('grid-to-home-path');
                    if(gridPath) {
                        gridPath.classList.remove('hidden');
                        gridPath.classList.add('flow-line-blue');
                    }
                    break;
                case 'Selling':
                    const sellPath = getPathElement('solar-to-grid-path');
                    if (sellPath) {
                        sellPath.classList.remove('hidden');
                        sellPath.classList.add('flow-line-red');
                    }
                    break;
            }
            
            const gridCurrent = (Math.random() * 5 + 10).toFixed(1);
            const gridVoltage = (Math.random() * 10 + 235).toFixed(0);
            const monthlyBill = (parseFloat(document.getElementById('today-usage').textContent) * 30 * 6.50).toFixed(2);
            
            const gridCurrentEl = document.getElementById('grid-current');
            if (gridCurrentEl) gridCurrentEl.textContent = `${gridCurrent}A`;
            
            const gridVoltageEl = document.getElementById('grid-voltage');
            if (gridVoltageEl) gridVoltageEl.textContent = `${gridVoltage}V`;

            const gridBillEl = document.getElementById('grid-bill');
            if (gridBillEl) gridBillEl.textContent = `₹ ${monthlyBill}`;
            
            const meterCurrentEl = document.getElementById('meter-current');
            if (meterCurrentEl) meterCurrentEl.textContent = `${(currentLoad / (gridVoltage / 1000)).toFixed(1)}A`;
            
            const meterVoltageEl = document.getElementById('meter-voltage');
            if (meterVoltageEl) meterVoltageEl.textContent = `${gridVoltage}V`;

            const anomalyAlert = document.getElementById('anomaly-alert');
            if (anomalyAlert) {
                if (Math.random() < 0.1) {
                    anomalyAlert.classList.remove('hidden');
                } else {
                    anomalyAlert.classList.add('hidden');
                }
            }

            const batteryAlert = document.getElementById('battery-health-alert');
            if (batteryAlert) {
                if (parseInt(batteryLevel) < 20 || parseInt(batteryLevel) > 95) {
                    batteryAlert.classList.remove('hidden');
                } else {
                    batteryAlert.classList.add('hidden');
                }
            }

            const aiRecommendationEl = document.getElementById('ai-recommendation');
            if (isEmergencyMode) {
                aiRecommendationEl.textContent = 'You have to purchase energy from the grid. Turn on lights, but do not use heavy appliances.';
                aiRecommendationEl.parentElement.classList.remove('bg-blue-50', 'border-blue-500');
                aiRecommendationEl.parentElement.classList.add('bg-red-50', 'border-red-500');
                aiRecommendationEl.previousElementSibling.firstElementChild.className = 'fas fa-exclamation-triangle';
                aiRecommendationEl.previousElementSibling.classList.remove('text-blue-800');
                aiRecommendationEl.previousElementSibling.classList.add('text-red-800');
                aiRecommendationEl.classList.remove('text-blue-700');
                aiRecommendationEl.classList.add('text-red-700');
            } else {
                const netSurplus = (totalGeneration - currentLoad).toFixed(1);
                const recommendations = [
                    `Current generation surplus of ${netSurplus} kW. Consider charging your EV or running heavy appliances.`,
                    `Your battery level is at ${batteryLevel}%. We recommend charging fully before nightfall.`,
                    `Predicted cloud cover tomorrow. Adjust your energy usage plan to minimize grid dependency.`,
                    `Excellent efficiency! You've offset ${carbonSaved} kg of CO₂ today.`
                ];
                if (aiRecommendationEl) {
                    aiRecommendationEl.textContent = recommendations[Math.floor(Math.random() * recommendations.length)];
                    aiRecommendationEl.parentElement.classList.add('bg-blue-50', 'border-blue-500');
                    aiRecommendationEl.parentElement.classList.remove('bg-red-50', 'border-red-500');
                    aiRecommendationEl.previousElementSibling.firstElementChild.className = 'fas fa-robot';
                    aiRecommendationEl.previousElementSibling.classList.add('text-blue-800');
                    aiRecommendationEl.previousElementSibling.classList.remove('text-red-800');
                    aiRecommendationEl.classList.add('text-blue-700');
                    aiRecommendationEl.classList.remove('text-red-700');
                }
            }

            const analyticsGenEl = document.getElementById('analytics-gen');
            if (analyticsGenEl) {
                analyticsGenEl.textContent = `${totalGeneration.toFixed(1)} kWh`;
            }
            const analyticsConEl = document.getElementById('analytics-con');
            if (analyticsConEl) {
                analyticsConEl.textContent = `${currentLoad.toFixed(1)} kWh`;
            }
            const analyticsSurplusEl = document.getElementById('analytics-surplus');
            if (analyticsSurplusEl) {
                analyticsSurplusEl.textContent = `${(totalGeneration - currentLoad).toFixed(1)} kWh`;
            }

            // Sync with Firestore
            if (userDocRef) {
                setDoc(userDocRef, {
                    mockBatteryLevel: mockBatteryLevel,
                    mockWeatherCondition: mockWeatherCondition,
                    currentLoad: currentLoad,
                    totalGeneration: totalGeneration,
                    plantType: currentPlantType,
                    isEmergencyMode: isEmergencyMode,
                    lastUpdated: Date.now()
                }).catch(console.error);
            }
        };

        const initializeDashboard = () => {
            const loginPage = document.getElementById('login-page');
            const mainDashboard = document.getElementById('main-dashboard');
            
            loginPage.classList.add('hidden');
            mainDashboard.classList.remove('hidden');

            const clientIdEl = document.getElementById('client-id');
            if (clientIdEl) clientIdEl.textContent = userId;
            const energyBalanceEl = document.getElementById('energy-balance');
            if (energyBalanceEl) energyBalanceEl.textContent = `₹ ${tradeState.balance.toFixed(2)}`;
            
            updatePlantUI();

            const tabs = document.querySelectorAll('.nav-tab');
            const panels = document.querySelectorAll('.panel');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const panelId = tab.getAttribute('data-panel') + '-panel';
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    panels.forEach(p => p.classList.remove('active'));
                    
                    const activePanel = document.getElementById(panelId);
                    if (activePanel) activePanel.classList.add('active');
                });
            });
            
            initCharts();
            updateWeather();
            
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    mockBatteryLevel = data.mockBatteryLevel;
                    mockWeatherCondition = data.mockWeatherCondition;
                    currentLoad = data.currentLoad;
                    currentPlantType = data.plantType;
                    isEmergencyMode = data.isEmergencyMode;
                    updateDashboardUIFromData();
                } else {
                    // Initialize user data if it doesn't exist
                    setDoc(userDocRef, {
                        mockBatteryLevel: mockBatteryLevel,
                        mockWeatherCondition: mockWeatherCondition,
                        currentLoad: currentLoad,
                        totalGeneration: 0,
                        plantType: currentPlantType,
                        isEmergencyMode: isEmergencyMode,
                        lastUpdated: Date.now()
                    }).catch(console.error);
                }
            });

            setInterval(updateLiveMetrics, 5000);
        };

        const updateDashboardUIFromData = () => {
             // UI update logic based on fetched data
            const lastUpdatedEl = document.getElementById('last-updated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }

            const totalGeneration = currentPlantType === 'Solar' ? 2.5 : 1.5; // Example based on plant type
            
            const batteryLevelEl = document.getElementById('battery-level-value');
            if (batteryLevelEl) batteryLevelEl.textContent = Math.round(mockBatteryLevel);
            
            const batteryProgressEl = document.getElementById('battery-progress');
            if (batteryProgressEl) batteryProgressEl.style.width = `${mockBatteryLevel}%`;
            
            const currentLoadEl = document.getElementById('current-load');
            if (currentLoadEl) currentLoadEl.textContent = currentLoad.toFixed(1);
            
            const consumptionProgressEl = document.getElementById('consumption-progress');
            if (consumptionProgressEl) consumptionProgressEl.style.width = `${(currentLoad / 5) * 100}%`;
            
            const aiRecommendationEl = document.getElementById('ai-recommendation');
            if (isEmergencyMode) {
                aiRecommendationEl.textContent = 'You have to purchase energy from the grid. Turn on lights, but do not use heavy appliances.';
                aiRecommendationEl.parentElement.classList.remove('bg-blue-50', 'border-blue-500');
                aiRecommendationEl.parentElement.classList.add('bg-red-50', 'border-red-500');
                aiRecommendationEl.previousElementSibling.firstElementChild.className = 'fas fa-exclamation-triangle';
                aiRecommendationEl.previousElementSibling.classList.remove('text-blue-800');
                aiRecommendationEl.previousElementSibling.classList.add('text-red-800');
                aiRecommendationEl.classList.remove('text-blue-700');
                aiRecommendationEl.classList.add('text-red-700');
                document.getElementById('purchase-energy-btn').classList.remove('hidden');
            } else {
                const netSurplus = (totalGeneration - currentLoad).toFixed(1);
                const recommendations = [
                    `Current generation surplus of ${netSurplus} kW. Consider charging your EV or running heavy appliances.`,
                    `Your battery level is at ${mockBatteryLevel}%. We recommend charging fully before nightfall.`,
                    `Predicted cloud cover tomorrow. Adjust your energy usage plan to minimize grid dependency.`,
                    `Excellent efficiency! You've offset ${totalGeneration * 0.5} kg of CO₂ today.`
                ];
                aiRecommendationEl.textContent = recommendations[Math.floor(Math.random() * recommendations.length)];
                aiRecommendationEl.parentElement.classList.add('bg-blue-50', 'border-blue-500');
                aiRecommendationEl.parentElement.classList.remove('bg-red-50', 'border-red-500');
                aiRecommendationEl.previousElementSibling.firstElementChild.className = 'fas fa-robot';
                aiRecommendationEl.previousElementSibling.classList.add('text-blue-800');
                aiRecommendationEl.previousElementSibling.classList.remove('text-red-800');
                aiRecommendationEl.classList.add('text-blue-700');
                aiRecommendationEl.classList.remove('text-red-700');
                document.getElementById('purchase-energy-btn').classList.add('hidden');
            }
            updateWeatherUI();
            updateEnergyFlowUI(isEmergencyMode ? 'Grid' : currentPlantType, totalGeneration, currentLoad, mockBatteryLevel);
        };
        
        const updateWeatherUI = () => {
            const weatherTempEl = document.getElementById('weather-temp');
            const weatherConditionEl = document.getElementById('weather-condition');
            const weatherIconEl = document.getElementById('weather-icon');
            
            if (weatherTempEl) weatherTempEl.textContent = (Math.random() * 4 + 27).toFixed(1);
            if (weatherConditionEl) weatherConditionEl.textContent = mockWeatherCondition;
            
            let icon;
            switch(mockWeatherCondition) {
                case 'Cloudy': icon = 'fas fa-cloud'; break;
                case 'Rain': icon = 'fas fa-cloud-rain'; break;
                case 'Partly Cloudy': icon = 'fas fa-cloud-sun'; break;
                default: icon = 'fas fa-sun'; break;
            }
            if (weatherIconEl) weatherIconEl.className = `text-5xl md:text-6xl text-yellow-500 ${icon}`;
        }
        
        const updateEnergyFlowUI = (source, totalGeneration, currentLoad, batteryLevel) => {
             const flowSolarOutputEl = document.getElementById('flow-solar-output');
            if (flowSolarOutputEl) flowSolarOutputEl.textContent = `${totalGeneration.toFixed(1)} kW`;
            
            const flowBatteryStatusEl = document.getElementById('flow-battery-status');
            if (flowBatteryStatusEl) flowBatteryStatusEl.textContent = `${Math.round(batteryLevel)}%`;
            
            const flowHomeLoadEl = document.getElementById('flow-home-load');
            if (flowHomeLoadEl) flowHomeLoadEl.textContent = `${currentLoad.toFixed(1)} kW`;
            
            const flowLoadSourceEl = document.getElementById('flow-load-source');
            if (flowLoadSourceEl) flowLoadSourceEl.textContent = `Sourced from: ${source}`;
            
            document.querySelectorAll('.energy-flow-path').forEach(el => {
                el.classList.add('hidden');
                el.classList.remove('flow-line-green', 'flow-line-yellow', 'flow-line-blue', 'flow-line-red');
            });
            
            const getPathElement = (pathId) => document.getElementById(pathId);
            switch (source) {
                case 'Solar':
                    const solarPath = getPathElement('solar-to-home-path');
                    if(solarPath) {
                        solarPath.classList.remove('hidden');
                        solarPath.classList.add('flow-line-yellow');
                    }
                    break;
                case 'Wind':
                    const windPath = getPathElement('wind-to-home-path');
                    if(windPath) {
                        windPath.classList.remove('hidden');
                        windPath.classList.add('flow-line-blue');
                    }
                    break;
                case 'Hybrid':
                    const hybridPath = getPathElement('solar-to-home-path');
                    if(hybridPath) {
                        hybridPath.classList.remove('hidden');
                        hybridPath.classList.add('flow-line-green');
                    }
                    break;
                case 'Battery':
                    const batteryPath = getPathElement('battery-to-home-path');
                    if(batteryPath) {
                        batteryPath.classList.remove('hidden');
                        batteryPath.classList.add('flow-line-green');
                    }
                    break;
                case 'Grid':
                    const gridPath = getPathElement('grid-to-home-path');
                    if(gridPath) {
                        gridPath.classList.remove('hidden');
                        gridPath.classList.add('flow-line-blue');
                    }
                    break;
                case 'Selling':
                    const sellPath = getPathElement('solar-to-grid-path');
                    if (sellPath) {
                        sellPath.classList.remove('hidden');
                        sellPath.classList.add('flow-line-red');
                    }
                    break;
            }
        };


        document.addEventListener('DOMContentLoaded', async () => {
            setLogLevel('debug');
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. App cannot run without it.");
                return;
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            await new Promise((resolve) => {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                userId = userCredential.user.uid;
                            } else {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                            }
                        } catch (error) {
                            console.error("Firebase auth failed:", error);
                        }
                    }
                    resolve();
                });
            });

            userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data/microgrid`);

            const loginPage = document.getElementById('login-page');
            const mainDashboard = document.getElementById('main-dashboard');
            const loginForm = document.getElementById('login-form');
            
            const emergencyAlertContainer = document.getElementById('emergency-alert-container');
            const emergencyAlertCloseBtn = document.getElementById('emergency-alert-close-btn');
            const alertSound = document.getElementById('alert-sound');

            const chatBotIcon = document.getElementById('chat-bot-icon');
            const chatContainer = document.getElementById('chat-container');
            const closeChatBtn = document.getElementById('close-chat');
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const purchaseEnergyBtn = document.getElementById('purchase-energy-btn');

            const addMessage = (message, isUser) => {
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message-text ${isUser ? 'user-message' : 'bot-message'}`;
                messageElement.textContent = message;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const contact = document.getElementById('contact').value;
                currentPlantType = document.getElementById('plant-type').value;

                if (contact && currentPlantType) {
                    await setDoc(userDocRef, {
                        contact: contact,
                        plantType: currentPlantType,
                        mockBatteryLevel: 72,
                        mockWeatherCondition: 'Clear Sky',
                        currentLoad: 2.8,
                        totalGeneration: 3.2,
                        isEmergencyMode: false,
                        lastUpdated: Date.now()
                    });
                    initializeDashboard();
                } else {
                    alert('Please enter all fields.');
                }
            });
            
            if (userId) {
                const docSnap = await onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        currentPlantType = data.plantType;
                        mockBatteryLevel = data.mockBatteryLevel;
                        mockWeatherCondition = data.mockWeatherCondition;
                        currentLoad = data.currentLoad;
                        isEmergencyMode = data.isEmergencyMode;
                        updateDashboardUIFromData();
                    }
                });

                if (docSnap) {
                    initializeDashboard();
                } else {
                    loginPage.classList.remove('hidden');
                    mainDashboard.classList.add('hidden');
                }
            } else {
                loginPage.classList.remove('hidden');
                mainDashboard.classList.add('hidden');
            }
            
            const showEmergencyAlert = () => {
                emergencyAlertContainer.classList.remove('hidden');
                alertSound.play().catch(e => console.error("Audio playback failed:", e));
            };

            const hideEmergencyAlert = () => {
                emergencyAlertContainer.classList.add('hidden');
                alertSound.pause();
                alertSound.currentTime = 0;
            };

            emergencyAlertCloseBtn.addEventListener('click', hideEmergencyAlert);

            chatBotIcon.addEventListener('click', () => {
                chatContainer.classList.toggle('hidden');
            });
            closeChatBtn.addEventListener('click', () => {
                chatContainer.classList.add('hidden');
            });

            chatInput.addEventListener('keydown', async (event) => {
                if (event.key === 'Enter') {
                    const userMessage = chatInput.value.trim().toLowerCase();
                    if (userMessage) {
                        addMessage(userMessage, true);
                        chatInput.value = '';

                        if (userMessage === 'no sun no battery') {
                            isEmergencyMode = true;
                            await setDoc(userDocRef, {
                                mockBatteryLevel: 25,
                                mockWeatherCondition: 'Cloudy',
                                currentLoad: 1.5,
                                isEmergencyMode: true,
                                plantType: currentPlantType
                            }, { merge: true });

                            addMessage("Emergency mode activated. Switching to grid power is recommended. You can now purchase energy from the grid.", false);
                            showEmergencyAlert();
                        } else {
                            isEmergencyMode = false;
                            addMessage("I can only process the 'no sun no battery' command right now.", false);
                        }
                    }
                }
            });
            
            purchaseEnergyBtn.addEventListener('click', async () => {
                if (isEmergencyMode) {
                    const purchaseQuantity = parseFloat(document.getElementById('current-load').textContent);
                    const cost = purchaseQuantity * 6.50;
                    tradeState.balance -= cost;
                    const energyBalanceEl = document.getElementById('energy-balance');
                    if (energyBalanceEl) energyBalanceEl.textContent = `₹ ${tradeState.balance.toFixed(2)}`;
                    addMessage(`Purchased ${purchaseQuantity.toFixed(1)} kWh from the grid for ₹${cost.toFixed(2)}.`, false);
                    await setDoc(userDocRef, {
                        isEmergencyMode: false, // Exit emergency mode after purchase
                        mockBatteryLevel: mockBatteryLevel + purchaseQuantity * 5, // Simulates charging battery
                        currentLoad: parseFloat((Math.random() * 4 + 1).toFixed(1))
                    }, { merge: true });
                } else {
                    addMessage("Emergency mode is not active. Please type 'no sun no battery' to activate it.", false);
                }
            });

            // Rest of your functions (renderTransactionHistory, initCharts, etc.) can go here
            const renderTransactionHistory = () => {};
            const initCharts = () => {};
            const updateWeather = () => {};
        });
    </script>
</body>
</html>
